<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="a/runno.js"></script>
    <script src="a/wasi.js"></script>
    <script src="a/snippet.js"></script>
    <link rel="stylesheet" href="a/snippet.css" />

    <script>
        // Function to get URL parameters
        function getUrlParams() {
            const params = {};
            const queryString = window.location.search.slice(1);
            const queryArray = queryString.split('&');

            queryArray.forEach(param => {
                const [key, value] = param.split('=');
                params[key] = decodeURIComponent(value.replace(/\+/g, ' ')); // Replace + with space
            });

            return params;
        }

        // Basic sanitization and validation for SQL queries
        function sanitizeSql(query) {
            // Disallow certain SQL commands that could be harmful
            const disallowedCommands = /(\bDROP\b|\bDELETE\b|\bUPDATE\b|\bINSERT\b)/i;
            if (disallowedCommands.test(query)) {
                return false;
            }
            return true;
        }

        // Function to log queries
        function logQuery(query) {
            // Implement your logging mechanism here
            // For example, send the query to a server endpoint or log it to the console
            console.log("Executed query:", query);
        }

        // Function to trim whitespace from the SQL query
        function trimWhitespace(query) {
            return query.trim();
        }

        // Function to encode query using URL-safe Base64
        function encodeQuery(query) {
            return btoa(query).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        // Function to decode URL-safe Base64 encoded query
        function decodeQuery(encodedQuery) {
            encodedQuery = encodedQuery.replace(/-/g, '+').replace(/_/g, '/');
            while (encodedQuery.length % 4) {
                encodedQuery += '=';
            }
            return atob(encodedQuery);
        }

        // Function to update the SQL query in the <pre> tag
        function updateSqlQuery() {
            const params = getUrlParams();
            const preElement = document.querySelector('pre');

            if (params.q && sanitizeSql(decodeQuery(params.q))) {
                preElement.textContent = trimWhitespace(decodeQuery(params.q));
            } else {
                preElement.textContent = 'select information from cups where cup = 0;';
            }
        }

        // Function to update the URL with the new query
        function updateUrlWithQuery(query) {
            query = trimWhitespace(query);
            if (sanitizeSql(query)) {
                const encodedQuery = encodeQuery(query);
                if (encodedQuery.length <= 2000) { // Check if the encoded query is within a reasonable length
                    const url = new URL(window.location);
                    url.searchParams.set('q', encodedQuery);
                    window.history.pushState({}, '', url);
                } else {
                    alert("The query is too long to be encoded in the URL.");
                }
            }
        }

        // Function to handle the run button click event
        function handleRunButtonClick() {
            let query = document.querySelector('pre').textContent;
            query = trimWhitespace(query);
            if (sanitizeSql(query)) {
                logQuery(query);
                updateUrlWithQuery(query);
            } else {
                alert("Invalid or unsafe SQL query detected.");
            }
        }

        // Function to add event listener to the run button in the shadow DOM
        function addRunButtonListener() {
            const codapiSnippet = document.querySelector('codapi-snippet');
            
            if (codapiSnippet) {
                const runButton = codapiSnippet.querySelector('button');
                
                if (runButton) {
                    runButton.addEventListener('click', handleRunButtonClick);
                } else {
                    setTimeout(addRunButtonListener, 500);
                }
            } else {
                setTimeout(addRunButtonListener, 500);
            }
        }

        // Run the function to update the SQL query and add event listener when the page loads
        window.onload = function() {
            updateSqlQuery();
            addRunButtonListener();
        };
    </script>
</head>
<body>
    <pre>
        select information from cups where cup = 0;
    </pre>

    <codapi-snippet engine="wasi" sandbox="sqlite" editor="basic" template="wcup.sql"></codapi-snippet>
</body>
</html>

